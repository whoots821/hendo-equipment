<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hendo Equipment | Attachments & Pricing</title>

<style>
:root{
  --bg:#f4f6f4;--panel:#fff;--panelAlt:#eef2ee;--text:#0f172a;
  --muted:#475569;--border:#d1d5db;--accent:#6b7f3a;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:0 auto;padding:16px}

header{background:#fff;border-bottom:4px solid var(--accent)}
.headerRow{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.brand h1{margin:0;font-size:22px}
.badgeRow{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.badge{padding:6px 10px;border-radius:999px;background:var(--panelAlt);
  border:1px solid var(--border);font-size:12px;font-weight:900}

.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);
  background:#fff;font-weight:900;cursor:pointer;text-decoration:none;display:inline-block}
.btnPrimary{background:var(--accent);color:#fff;border:none}

.layout{display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:16px}
@media(max-width:900px){.layout{grid-template-columns:1fr}}

.sidebar{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
.sideTitle{font-weight:900;color:var(--accent);margin-bottom:8px}

.machineTabs button,
.catBtn{
  width:100%;text-align:left;padding:10px;border-radius:8px;
  border:1px solid var(--border);background:#fff;font-weight:900;
  cursor:pointer;margin-bottom:6px
}
.machineTabs button.active,
.catBtn.active{background:var(--panelAlt);border-color:var(--accent)}

.content{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px}

.pageTitle{display:flex;flex-direction:column;gap:4px;margin-bottom:10px}
.pageTitle h2{margin:0;font-size:18px}
.small{font-size:12px;color:var(--muted)}

.tilesGrid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:12px;
  margin-top:12px;
}
.tile{
  border:1px solid var(--border);
  border-radius:14px;
  background:#fff;
  overflow:hidden;
}
.tileHead{
  padding:12px;
  background:var(--panelAlt);
  border-bottom:1px solid var(--border);
}
.tileHead .name{font-weight:1000}
.tileBody{padding:12px;display:grid;gap:10px}
.filters{display:flex;gap:10px;flex-wrap:wrap}
.field label{font-size:12px;font-weight:900;color:var(--muted)}
select{padding:10px;border-radius:8px;border:1px solid var(--border);min-width:160px}

.priceBig{font-size:22px;font-weight:1100}

.debugBox{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  border:1px dashed var(--border);
  background:#fafafa;
  font-size:12px;
  color:var(--muted);
  display:none;
  white-space:pre-wrap;
}

footer{margin-top:24px;border-top:1px solid var(--border);background:#fff}
</style>
</head>

<body>
<header>
  <div class="container headerRow">
    <div class="brand">
      <h1>Hendo Equipment</h1>
      <div class="badgeRow">
        <span class="badge">ðŸ‡ºðŸ‡¸ USA Made</span>
        <span class="badge">Veteran Owned & Operated</span>
      </div>
    </div>
    <div>
      <a class="btn btnPrimary" href="tel:+18286990157">(828) 699-0157</a>
    </div>
  </div>
</header>

<main class="container">
  <section class="layout">
    <aside class="sidebar">
      <div class="sideTitle">Machine</div>
      <div class="machineTabs" id="machineTabs"></div>

      <div class="sideTitle">Categories</div>
      <div id="catList"></div>

      <div class="debugBox" id="debugBox"></div>
    </aside>

    <section class="content">
      <div class="pageTitle">
        <h2 id="categoryTitle">Select a category</h2>
        <div class="small" id="categoryHint">Choose a machine and category on the left. Then pick duty + width and price updates instantly.</div>
        <div class="small" id="status">Loading catalogâ€¦</div>
      </div>

      <div id="tiles" class="tilesGrid"></div>
    </section>
  </section>
</main>

<footer>
  <div class="container small">
    Â© Hendo Equipment â€¢ Hendersonville, NC
  </div>
</footer>

<script>
/* =========================================================
   FIXED VERSION (WHY YOU SAW NO MACHINES/CATEGORIES)
   Most common causes:
   1) The JSON file is not being loaded (wrong path / not on GitHub Pages)
   2) The JSON format doesn't match what the script expects
   This code supports BOTH formats:
     A) { "categories": [ ... ] }   (the version I generated earlier)
     B) { "TAB NAME": { items: [...] }, ... } (tab-keyed object)
   ========================================================= */

/* ---------- IMPORTANT SETTINGS ---------- */

// If you're using GitHub Pages, this relative path works IF the file exists:
//   repo root -> /data/hendo_catalog.json
// If you are viewing the file on github.com (the "blob" page), fetch will NOT work.
// You must open the site on GitHub Pages (whoots821.github.io/...).
const DATA_URL = "./data/hendo_catalog.json";

// Email address for quote button:
const QUOTE_EMAIL = "whoots821@gmail.com";

// Turn on debug readout (shows in sidebar) if something fails:
const DEBUG = true;

/* ---------- helpers ---------- */
const escAttr = s => String(s ?? "").replace(/"/g,'&quot;').replace(/</g,'&lt;');
const norm = s => String(s ?? "").toLowerCase().trim();
const money = n => {
  const num = Number(n);
  if (!Number.isFinite(num)) return "â€”";
  return "$" + Math.round(num).toLocaleString();
};
const uniq = arr => [...new Set((arr||[]).filter(v => v !== undefined && v !== null && v !== ""))];
const numericSort = arr => uniq(arr).slice().sort((a,b)=>Number(a)-Number(b));

/* ---------- machine mapping (keeps your sidebar layout) ---------- */
function inferMachine(categoryName){
  const n = norm(categoryName);
  if (n.includes("tractor")) return "Tractor";
  if (n.includes("excavator")) return "Excavator";
  if (n.includes("mini")) return "Mini Skid Steer";
  return "Skid/Track Loader";
}

/* ---------- DOM ---------- */
const machineTabs = document.getElementById("machineTabs");
const catList = document.getElementById("catList");
const tilesEl = document.getElementById("tiles");
const statusEl = document.getElementById("status");
const categoryTitle = document.getElementById("categoryTitle");
const categoryHint = document.getElementById("categoryHint");
const debugBox = document.getElementById("debugBox");

/* ---------- state ---------- */
let CATEGORIES = [];            // [{ id, label, machine, items }]
let MACHINES = [];              // ["Skid/Track Loader", ...]
let machine = null;             // selected machine
let category = null;            // selected category object

/* ---------- debug ---------- */
function setDebug(text){
  if (!DEBUG) return;
  debugBox.style.display = "block";
  debugBox.textContent = text;
}
function clearDebug(){
  debugBox.style.display = "none";
  debugBox.textContent = "";
}

/* ---------- detect + normalize JSON formats ---------- */
function normalizeCatalog(data){
  // Format A: { categories: [ {name, slug, items:[{name, variants, lookup, options...}]} ] }
  if (data && Array.isArray(data.categories)) {
    const cats = data.categories.map(c => ({
      id: c.name || c.slug || "Category",
      label: c.name || c.slug || "Category",
      machine: inferMachine(c.name || c.slug || ""),
      items: Array.isArray(c.items) ? c.items : []
    }));
    cats.sort((a,b)=>a.label.localeCompare(b.label));
    return cats;
  }

  // Format B: { "TAB NAME": { category, items: [...] }, ... }
  if (data && typeof data === "object" && !Array.isArray(data)) {
    const entries = Object.entries(data);
    // if it's empty object, return empty
    if (!entries.length) return [];

    const cats = entries.map(([tabName, obj]) => {
      const label = obj?.category || tabName;
      return {
        id: tabName,
        label,
        machine: inferMachine(label),
        items: Array.isArray(obj?.items) ? obj.items : []
      };
    });

    // If it looks like a plain data object but not our catalog, still return it sorted
    cats.sort((a,b)=>a.label.localeCompare(b.label));
    return cats;
  }

  return [];
}

function buildMachines(categories){
  const set = new Set(categories.map(c => c.machine));
  const order = ["Skid/Track Loader", "Mini Skid Steer", "Tractor", "Excavator"];
  return order.filter(m => set.has(m));
}

/* ---------- variant lookup ---------- */
function getVariant(item, duty, width){
  // lookup keys are "Duty|Width" OR "|Width" when duty is blank
  const d = duty ? String(duty) : "";
  const w = (width === "" || width === null || width === undefined) ? "" : String(width);
  const key = `${d}|${w}`;
  return item.lookup?.[key] || null;
}

/* ---------- render ---------- */
function renderMachines(){
  machineTabs.innerHTML = (MACHINES||[]).map(m => `
    <button class="${m===machine ? "active" : ""}" onclick="setMachine('${escAttr(m)}')">${m}</button>
  `).join("") || `<div class="small">No machines found.</div>`;
}

function renderCats(){
  const list = CATEGORIES.filter(c => c.machine === machine);
  catList.innerHTML = list.map(c => `
    <button class="catBtn ${category && category.id===c.id ? "active" : ""}" onclick="setCategory('${escAttr(c.id)}')">
      ${c.label}
    </button>
  `).join("");

  if (!list.length){
    catList.innerHTML = `<div class="small">No categories for this machine.</div>`;
  }
}

function makeTile(item){
  // Prefer the JSON's precomputed options if present
  const duties = uniq(item?.options?.duty || []).filter(d => norm(d) !== "none");
  const widths = numericSort(item?.options?.width || []);

  // If options are missing, attempt to infer from variants
  const dutyFallback = duties.length ? duties : uniq((item?.variants || []).map(v=>v.duty)).filter(d=>d && norm(d)!=="none");
  const widthFallback = widths.length ? widths : numericSort((item?.variants || []).map(v=>v.width));

  const finalDuties = dutyFallback;
  const finalWidths = widthFallback;

  let selectedDuty = finalDuties.length ? finalDuties[0] : "";
  let selectedWidth = finalWidths.length ? finalWidths[0] : "";

  const tile = document.createElement("div");
  tile.className = "tile";

  tile.innerHTML = `
    <div class="tileHead">
      <div class="name">${escAttr(item?.name || "Item")}</div>
    </div>
    <div class="tileBody">
      <div class="filters">
        ${finalDuties.length ? `
          <div class="field">
            <label>Duty</label>
            <select class="dutySel">
              <option value="">Select duty</option>
              ${finalDuties.map(d => `<option value="${escAttr(d)}">${d}</option>`).join("")}
            </select>
          </div>
        ` : ""}
        <div class="field">
          <label>Width (in)</label>
          <select class="widthSel">
            <option value="">Select width</option>
            ${finalWidths.map(w => `<option value="${escAttr(w)}">${w}"</option>`).join("")}
          </select>
        </div>
      </div>

      <div>
        <div class="small">Selected SKU</div>
        <div class="skuOut" style="font-weight:900">â€”</div>
      </div>

      <div>
        <div class="small">Price</div>
        <div class="priceOut priceBig">â€”</div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn btnPrimary emailBtn" href="#">Email Quote</a>
      </div>
    </div>
  `;

  const dutySel = tile.querySelector(".dutySel");
  const widthSel = tile.querySelector(".widthSel");
  const skuOut = tile.querySelector(".skuOut");
  const priceOut = tile.querySelector(".priceOut");
  const emailBtn = tile.querySelector(".emailBtn");

  function update(){
    const d = dutySel ? dutySel.value : "";
    const w = widthSel ? widthSel.value : "";

    // If item.lookup exists, use it; otherwise try to find match in variants
    let v = null;
    if (item.lookup) {
      v = getVariant(item, d, w);
    } else if (Array.isArray(item.variants)) {
      v = item.variants.find(x =>
        (d ? norm(x.duty)===norm(d) : true) &&
        (w ? String(x.width)===String(w) : true)
      ) || null;
    }

    skuOut.textContent = v?.sku || "â€”";
    priceOut.textContent = v ? money(v.price) : "â€”";

    const subject = encodeURIComponent(`Quote request: ${(item?.name || "Item")} ${v?.sku ? "(" + v.sku + ")" : ""}`);
    const body = encodeURIComponent(
      `Hi Hendo Equipment,\n\n` +
      `Iâ€™d like a quote for:\n` +
      `Category: ${category?.label || ""}\n` +
      `Item: ${item?.name || ""}\n` +
      (d ? `Duty: ${d}\n` : "") +
      (w ? `Width: ${w}"\n` : "") +
      (v?.sku ? `SKU: ${v.sku}\n` : "") +
      (v ? `Price shown: ${money(v.price)}\n` : "") +
      `\nName:\nPhone:\nLocation:\n\nThanks!`
    );

    emailBtn.href = `mailto:${QUOTE_EMAIL}?subject=${subject}&body=${body}`;
  }

  if (dutySel) dutySel.addEventListener("change", update);
  if (widthSel) widthSel.addEventListener("change", update);

  // set defaults (donâ€™t force if you want user to choose first)
  if (dutySel && selectedDuty) dutySel.value = selectedDuty;
  if (widthSel && selectedWidth) widthSel.value = String(selectedWidth);

  update();
  return tile;
}

function renderTiles(){
  tilesEl.innerHTML = "";

  if (!category){
    categoryTitle.textContent = "Select a category";
    categoryHint.textContent = "Choose a machine and category on the left. Then pick duty + width and price updates instantly.";
    return;
  }

  categoryTitle.textContent = category.label;
  categoryHint.textContent = "Pick duty + width. Price updates instantly.";

  const items = Array.isArray(category.items) ? category.items : [];
  if (!items.length){
    tilesEl.innerHTML = `<div class="small">No items found in this category.</div>`;
    return;
  }

  items.forEach(item => tilesEl.appendChild(makeTile(item)));
}

function render(){
  renderMachines();
  renderCats();
  renderTiles();
}

/* ---------- actions ---------- */
window.setMachine = function(m){
  machine = m;
  category = null;

  try { localStorage.setItem("hendo_machine", machine); } catch(e){}

  // auto-select first category for machine
  const catsForMachine = CATEGORIES.filter(c => c.machine === machine);
  category = catsForMachine[0] || null;

  render();
};

window.setCategory = function(id){
  category = CATEGORIES.find(c => c.id === id) || null;
  try { localStorage.setItem("hendo_category", category?.id || ""); } catch(e){}
  render();
};

/* ---------- init ---------- */
(async function init(){
  statusEl.textContent = "Loading catalogâ€¦";

  // Cache-bust so GitHub Pages doesnâ€™t serve old JSON
  const url = DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "v=" + Date.now();

  try{
    const res = await fetch(url, { cache: "no-store" });

    // If you're not on GitHub Pages and you're just viewing the GitHub "blob" page,
    // fetch will fail or return HTML, not JSON.
    const text = await res.text();

    // Try parse JSON
    let data;
    try {
      data = JSON.parse(text);
    } catch(parseErr) {
      throw new Error(
        "Catalog file did not return valid JSON. " +
        "This usually happens when you're not on GitHub Pages or the path is wrong."
      );
    }

    CATEGORIES = normalizeCatalog(data);
    MACHINES = buildMachines(CATEGORIES);

    if (!CATEGORIES.length || !MACHINES.length){
      setDebug(
        "Loaded JSON but found 0 categories/machines.\n\n" +
        "Checklist:\n" +
        "1) Confirm /data/hendo_catalog.json exists in repo\n" +
        "2) Confirm you opened the *GitHub Pages site*, not github.com blob\n" +
        "3) Open the JSON directly in browser and confirm it shows JSON\n\n" +
        "Path used:\n" + DATA_URL
      );
      statusEl.textContent = "No categories found. Check JSON path / format.";
      return;
    }

    // restore selections if possible
    let savedMachine = null;
    let savedCategory = null;
    try{
      savedMachine = localStorage.getItem("hendo_machine");
      savedCategory = localStorage.getItem("hendo_category");
    }catch(e){}

    machine = (savedMachine && MACHINES.includes(savedMachine)) ? savedMachine : MACHINES[0];

    const catsForMachine = CATEGORIES.filter(c => c.machine === machine);

    if (savedCategory && catsForMachine.some(c => c.id === savedCategory)){
      category = catsForMachine.find(c => c.id === savedCategory);
    } else {
      category = catsForMachine[0] || null;
    }

    clearDebug();
    statusEl.textContent = "";
    render();

  }catch(err){
    console.error(err);
    statusEl.textContent =
      "Could not load catalog JSON. Fix this and machines/categories will appear.";

    setDebug(
      "ERROR loading catalog:\n" + (err?.message || err) + "\n\n" +
      "IMPORTANT:\n" +
      "â€¢ If you're viewing https://github.com/.../index.html (the repo file), fetch won't work.\n" +
      "  You must open the GitHub Pages website:\n" +
      "  https://whoots821.github.io/hendo-equipment/\n\n" +
      "CHECKLIST:\n" +
      "1) Upload hendo_catalog.json to: /data/hendo_catalog.json in the repo\n" +
      "2) Turn on GitHub Pages (Settings â†’ Pages â†’ Deploy from branch)\n" +
      "3) Visit the JSON directly:\n" +
      "   https://whoots821.github.io/hendo-equipment/data/hendo_catalog.json\n"
    );
  }
})();
</script>
</body>
</html>
